## 文本和HTML模板
好的，没问题！我帮你把 gopl 4.6 节「文本和 HTML 模板」的核心内容提炼出来，让你快速掌握。别担心，这部分其实很有趣。

你可以把模板想象成一个**“挖了坑”的文本文件**，而我们的任务就是用 Go 程序**把正确的内容“填到”对应的坑里**。

这章主要讲了两种模板：`text/template` 和 `html/template`。

---

### **核心概念总览**

1.  **模板是什么？**
    *   一个带有特殊占位符（“坑”）的字符串或文件。
    *   这些占位符叫 **Action**，通常用 `{{ ... }}` 包裹。

2.  **数据驱动**
    *   模板是静态的，但输出是动态的。动态的部分来自于你传入的 Go 数据（比如一个结构体、map、切片或普通变量）。
    *   模板引擎的工作就是把你的数据“渲染”到模板的占位符中。

3.  **点 `.` 的含义**
    *   在模板里，`{{.}}` (一个点) 是一个非常重要的特殊变量，它代表**当前正在处理的数据**。如果传入一个结构体，`.` 就代表这个结构体；如果在循环里，`.` 就代表当前循环的元素。

---

### **第一部分：`text/template` (文本模板)**

这是基础版，用于生成任何纯文本格式的内容，比如邮件、配置文件、日志等。

**基本用法三步走：**

1.  **创建模板**：定义一个包含 `{{...}}` 的字符串。
    ```go
    const templateText = "报告：目前共有 {{.TotalCount}} 个问题，其中 {{.ActiveCount}} 个是活跃的。"
    ```

2.  **解析模板**：让 Go 理解这个模板的结构。
    ```go
    // Must 函数在解析失败时会直接 panic，适合在初始化时用
    tmpl := template.Must(template.New("report").Parse(templateText))
    ```

3.  **执行模板 (渲染)**：传入数据，生成最终文本。
    ```go
    // 准备数据
    data := struct {
        TotalCount  int
        ActiveCount int
    }{
        TotalCount:  10,
        ActiveCount: 3,
    }
    
    // 将渲染结果写入 os.Stdout (标准输出)
    tmpl.Execute(os.Stdout, data) 
    ```
    **输出结果：**
    ```
    报告：目前共有 10 个问题，其中 3 个是活跃的。
    ```

**模板里的常用“动作”(Actions)：**

*   **访问结构体字段**：`{{.FieldName}}`
    *   例如：`{{.TotalCount}}` 会访问上面 `data` 结构体的 `TotalCount` 字段。

*   **条件判断 `if`**：
    ```go
    {{if .ActiveCount}}
        有活跃问题！
    {{else}}
        没有活跃问题。
    {{end}}
    ```

*   **循环 `range`**：
    *   如果传入的是一个切片（slice）或 map，可以用 `range` 遍历。
    *   在 `range` 内部，`.` 会变成当前循环的元素。

    ```go
    // 假设传入的数据是：[]string{"Go", "Rust", "Python"}
    {{range .}}
        - 我在学习 {{.}}
    {{end}}
    ```
    **输出：**
    ```
    - 我在学习 Go
    - 我在学习 Rust
    - 我在学习 Python
    ```

*   **函数调用**：模板里可以调用预定义的函数或者你自定义的函数。
    *   比如 `printf` 函数：`{{printf "%.2f" 3.14159}}` -> 输出 "3.14"

---

### **第二部分：`html/template` (HTML 模板) —— 更安全！**

`html/template` 的用法和 `text/template` **几乎完全一样**，API 也相同。那为什么要有它呢？

**核心区别：自动进行上下文感知的安全转义！**

这是本节**最重要**的知识点。

当你生成 HTML 页面时，如果把用户输入的内容原封不动地放进去，会引发**跨站脚本攻击 (XSS)**。比如，一个恶意用户输入了 `<script>alert('Hacked!')</script>` 作为他的名字，如果你直接显示它，这段脚本就会在其他用户的浏览器里执行。

`html/template` 包能智能地识别出你正在把数据插入到 HTML 的哪个部分，并进行相应的转义，从而阻止这种攻击。

**它是如何工作的？**

*   **在普通的 HTML 文本中**：它会转义特殊字符。
    *   `>` 会变成 `&gt;`
    *   `<` 会变成 `&lt;`
    *   `&` 会变成 `&amp;`
    *   ...等等

    ```go
    // 假设 .Name = "<script>alert('oops')</script>"
    // 模板：<p>Name: {{.Name}}</p>
    // 输出的 HTML 源码会是：<p>Name: &lt;script&gt;alert(&#39;oops&#39;)&lt;/script&gt;</p>
    // 浏览器只会把这段文字显示出来，而不会执行它。
    ```

*   **在 HTML 属性中**：它会确保内容不会破坏属性的结构。
    *   `{{.URL}}` 放在 `href` 属性里时，它会检查 URL 的合法性。

*   **在 JavaScript 或 CSS 中**：它会进行更严格的编码，确保不会执行恶意代码。

**一句话总结：只要你是在生成 HTML，就必须使用 `html/template`，而不是 `text/template`！** 这能让你免受 XSS 攻击的困扰。

---

### **概括总结**

1.  **模板 = 文本 + `{{占位符}}`**。
2.  `text/template` 用于生成**任何纯文本**。
3.  `html/template` 用于生成 **HTML**，它和 `text/template` 用法一样，但**增加了自动安全转义功能，能防止 XSS 攻击**。
4.  `{{.}}` 是**当前数据**的引用。
5.  `{{.FieldName}}` 访问结构体字段。
6.  `{{if}}` 和 `{{range}}` 是控制逻辑的核心。
7.  **黄金法则：输出 HTML，就用 `html/template` 包！**

希望这个概括能帮你快速抓住重点！现在你已经了解了 Go 模板的核心思想和最佳实践了。

